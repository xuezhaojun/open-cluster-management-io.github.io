<!DOCTYPE html>
<html lang="zh"><head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"/>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css"/>
  <link rel="stylesheet" href="/main.css"/>
  <link rel="shortcut icon" type="image/svg" href="/ocm.svg">
  <title>Open Cluster Management</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1PXKZXT157"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-1PXKZXT157');
  </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">



    


<input id="current-lang" type="hidden" value="zh">

<header class="navbar navbar-expand-lg navbar-dark bd-navbar">
  <nav class="navbar navbar-expand-lg navbar-dark py-3 fixed-top">
    <div class="container-fluid flex-wrap flex-lg-nowrap">
      <a href="/zh/" class="navbar-brand">
        <img src="/ocm.svg" alt="" width="30" height="24" class="align-text-top">
        <span>Open Cluster Management</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navmenu">
        <ul class="navbar-nav ms-auto ">
          <li class="nav-item pe-2">
            <a href="/zh/community" class="nav-link text-light">社区</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/zh/contribute" class="nav-link text-light">贡献</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/zh/concepts" class="nav-link text-light">文档</a>
          </li>
          <li class="nav-item pe-2">
            <a href="/zh/blog" class="nav-link text-light">博客</a>
          </li>
          <li class="nav-item dropdown pe-2">
            
            <a class="nav-link dropdown-toggle text-light" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">中文</a>
            

            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              
              <li><a class="dropdown-item" href="#" id="to-en">English</a></li>
              
            </ul>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://www.youtube.com/c/OpenClusterManagement" target="_blank" aria-label="youtube">
                <i class="bi bi-youtube"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://github.com/open-cluster-management-io" target="_blank" aria-label="github">
              <i class="bi bi-github"></i>
            </a>
          </li>
          <li class="nav-item pe-2">
            <a class="nav-link text-light" href="https://kubernetes.slack.com/channels/open-cluster-mgmt" target="_blank" aria-label="slack">
              <i class="bi bi-slack"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>
</div>
        <div class="row subject-padding">
            <div class="col-lg-2 col-md-3 padding-none sidebar-bgc">



    


<div class="sidebar-toggle sidebar-toggle-sm">
    <button type="button" id="sidebarToggle" class="btn btn-info">
        <i class="bi bi-list"></i>
    </button>
</div>
<nav id="sidebar" class="sidebar-hide-sm">
    <ul class="components">
        <li id="concepts">
            <a class="navlink" href="/zh/concepts">概念</a>
            <ul class="collapse ">
                <li>
                    <a class="navlink" href="/zh/concepts/architecture">架构</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/clusterclaim">集群声明</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/managedcluster">托管集群</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/managedclusterset">托管集群分组</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/placement">匹配路由</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/manifestwork">资源下发</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/manifestworkreplicaset">资源下发组</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/addon">自定义插件</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/policy">Policy</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/concepts/multicluster-controlplane">多集群控制面</a>
                </li>
            </ul>
        </li>
        <li id="getting-started">
            <a class="navlink" href="/zh/getting-started">安装</a>
            <ul class="collapse ">
                <li>
                    <a class="navlink" href="/zh/getting-started/quick-start">快速开始</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/getting-started/installation">部署</a>
                    <ul class="collapse">
                        <li>
                            <a class="navlink" href="/zh/getting-started/installation/start-the-control-plane">启动控制面</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/installation/register-a-cluster">注册一个集群</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/zh/getting-started/integration">插件和集成</a>
                    <ul class="collapse ">
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/app-lifecycle">应用生命周期管理</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/cluster-proxy">多集群网络隧道</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/policy-framework">Policy框架</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/policy-controllers">Policy控制器</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/integration/managed-serviceaccount">托管多集群ServiceAccount</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink" href="/zh/getting-started/administration">运维管理</a>
                    <ul class="collapse ">
                        <li>
                            <a class="navlink" href="/zh/getting-started/administration/upgrading">升级版本</a>
                        </li>
                        <li>
                            <a class="navlink" href="/zh/getting-started/administration/monitoring">监控</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li id="developer-guides">
            <a class="navlink" href="/zh/developer-guides">开发指南</a>
            <ul class="collapse ">
                <li>
                    <a class="navlink" href="/zh/developer-guides/addon">Add-on 开发指南</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/developer-guides/vscode-extension">VScode插件</a>
                </li>
            </ul>
        </li>
        <li id="scenarios">
            <a class="navlink" href="/zh/scenarios">应用场景</a>
            <ul class="collapse ">
                <li>
                    <a class="navlink" href="/zh/scenarios/deploy-kubernetes-resources">部署Kubernetes资源</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/distribute-workload-with-placement">通过placement分发工作负载</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/migrate-workload-with-placement">通过placement迁移工作负载</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/extend-multicluster-scheduling-capabilities">扩展多集群调度能力</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/extending-managed-clusters">扩展集群模型</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/integration-with-argocd">集成Argo CD</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/manage-cluster-with-multiple-hubs">使用多个hub管理同一集群</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/pushing-kube-api-requests">向托管集群推送Kube API请求</a>
                </li>
                <li>
                    <a class="navlink" href="/zh/scenarios/register-cluster-through-proxy">通过代理服务器注册集群</a>
                </li>
            </ul>
        </li>
        <li id="community">
            <a class="navlink" href="/zh/community">社区</a>
            <ul class="collapse ">
                <li>
                    <a class="navlink" href="/zh/community/releases">发行版本</a>
                </li>
                <li >
                    <a class="navlink" href="/zh/community/roadmap">社区规划</a>
                </li>
            </ul>
        </li>
        <li id="contribute">
            <a class="navlink" href="/zh/contribute">贡献</a>
        </li>
        <li id="blog">
            <a class="navlink" href="/zh/blog">博客</a>
        </li>
        <li style="padding-top: 10px; border-top: 2px solid #448a78;">
            <a class="navlink resource" href="https://github.com/open-cluster-management-io" target="_blank"><i class="bi bi-github"></i><span style="padding-left: 10px;">GitHub</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://kubernetes.slack.com/channels/open-cluster-mgmt" target="_blank"><i class="bi bi-slack"></i><span style="padding-left: 10px;">Slack</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://www.youtube.com/c/OpenClusterManagement" target="_blank"><i class="bi bi-youtube"></i><span style="padding-left: 10px;">YouTube</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://groups.google.com/g/open-cluster-management" target="_blank"><i class="bi bi-envelope-fill"></i><span style="padding-left: 10px;">Mailing group</span></a>
        </li>
        <li>
            <a class="navlink resource" href="https://calendar.google.com/calendar/u/0/embed?src=openclustermanagement@gmail.com" target="_blank"><i class="bi bi-calendar-event-fill"></i><span style="padding-left: 10px;">Community meetings</span></a>
        </li>
    </ul>
</nav>
<script type="text/javascript" src="/sidebar.js"></script>
</div>
            <div class="col-lg-10 col-md-9 padding-none">
<div id="content">
    <h1>使用OCM让多集群调度更具可扩展性</h1>
    <p>2023年5月10日 <a href="https://github.com/haoqing0110">郝青</a></p>



  <div class="gdoc-toc gdoc-toc__level--6"><nav id="TableOfContents"><ul>
        <li><a href="#背景问题">背景问题</a></li>
        <li><a href="#ocm-如何让调度具有可扩展性">OCM 如何让调度具有可扩展性</a></li>
        <li><a href="#示例">示例</a></li>
        <li><a href="#如何实现自定义分数控制器">如何实现自定义分数控制器</a>
          <ul>
            <li><a href="#1-在哪里运行自定义分数控制器-controller">1. 在哪里运行自定义分数控制器 (controller)</a></li>
            <li><a href="#2-如何维护addonplacementscore的生命周期">2. 如何维护<code>AddOnPlacementScore</code>的生命周期</a></li>
            <li><a href="#3-如何计算分数">3. 如何计算分数</a></li>
          </ul>
        </li>
        <li><a href="#总结">总结</a></li>
      </ul></nav><hr></div>


<h2 id="背景问题">背景问题</h2>
<p>OCM Placement API 可以动态的在多集群环境中选择一组托管集群<code>ManagedCluster</code>，以便将工作负载部署到这些集群上。</p>
<p>在上一篇<a href="https://mp.weixin.qq.com/s/_k2MV4b3hfTrLUCCOKOG8g">CNCF 沙箱项目 OCM Placement 多集群调度指南</a>中，我们详细介绍了 Placement 的基本概念，提供的调度功能以及调度流程。同时还通过示例展示了如何在不同的应用场景下使用 Placement API。建议首次接触 Placement 的读者先阅读此文。</p>
<p>Placement 提供了通过标签选择器<code>labelSelector</code>或声明选择器<code>claimSelector</code>过滤集群，同时也提供了一些内置的优选器<code>prioritizer</code>，可对过滤后的集群进行打分排序和优先选择。
内置的<code>prioritizer</code>中包括了最大可分配 CPU 资源(ResourceAllocatableCPU)和最大可分配内存资源(ResourceAllocatableMemory)，它们提供了根据集群的可分配 CPU 和内存进行调度的能力。但是，由于集群的&quot;AllocatableCPU&quot;和&quot;AllocatableMemory&quot;是静态值，即使&quot;集群资源不足&rdquo;，它们也不会改变。这导致在实际使用中，这两个<code>prioritizer</code>不能满足基于实时可用 CPU 或内存进行调度的需求。此外，使用者还可能需要根据从集群中获取的资源监控数据进行调度，这些都是内置的<code>prioritizer</code>无法满足的需求。</p>
<p>以上这些需求要求 Placement 能够更灵活的根据第三方数据来进行调度。为此，我们实现了一种更具扩展性的方式来支持基于第三方数据的调度，使用者可以使用自定义的分数来选择集群。</p>
<p>本文将介绍 OCM 是如何让多集群调度更具可扩展性，并通过实例展示如何实现一个第三方数据控制器<code>controller</code>来扩展 OCM 的多集群调度功能。</p>
<h2 id="ocm-如何让调度具有可扩展性">OCM 如何让调度具有可扩展性</h2>
<p>为了实现基于第三方数据的调度，OCM 引入了 API <code>AddOnPlacementScore</code>，它支持存储自定义的集群分数，使用者可以在 Placement 中指定使用此分数选择集群。</p>
<p>如下是一个<code>AddOnPlacementScore</code>的例子，更多关于 API 的细节可访问<a href="https://github.com/open-cluster-management-io/api/blob/main/cluster/v1alpha1/types_addonplacementscore.go" title="types_addonplacementscore.go">types_addonplacementscore.go</a>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: cluster.open-cluster-management.io/v1alpha1
<span style="color:#66d9ef">kind</span>: AddOnPlacementScore
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: default
  <span style="color:#66d9ef">namespace</span>: cluster1
<span style="color:#66d9ef">status</span>:
  <span style="color:#66d9ef">conditions</span>:
  - <span style="color:#66d9ef">lastTransitionTime</span>: <span style="color:#e6db74">&#34;2021-10-28T08:31:39Z&#34;</span>
    <span style="color:#66d9ef">message</span>: AddOnPlacementScore updated successfully
    <span style="color:#66d9ef">reason</span>: AddOnPlacementScoreUpdated
    <span style="color:#66d9ef">status</span>: <span style="color:#e6db74">&#34;True&#34;</span>
    <span style="color:#66d9ef">type</span>: AddOnPlacementScoreUpdated
  <span style="color:#66d9ef">validUntil</span>: <span style="color:#e6db74">&#34;2021-10-29T18:31:39Z&#34;</span>
  <span style="color:#66d9ef">scores</span>:
  - <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;cpuAvailable&#34;</span>
    <span style="color:#66d9ef">value</span>: <span style="color:#ae81ff">66</span>
  - <span style="color:#66d9ef">name</span>: <span style="color:#e6db74">&#34;memAvailable&#34;</span>
    <span style="color:#66d9ef">value</span>: <span style="color:#ae81ff">55</span>
</code></pre></div><p><code>AddOnPlacementScore</code>的主要内容都在<code>status</code>中，因为我们不希望使用者更新它。<code>AddOnPlacementScore</code>的生命周期维护及<code>scores</code>的更新应该由第三方<code>controller</code>负责。</p>
<ul>
<li><code>conditions</code>包括了资源不同的条件状态。</li>
<li><code>scores</code>是一个列表，包含了一组分数的名称和值。在上例中，<code>scores</code>包含了自定义分数 cpuAvailable 和 memAvailable。</li>
<li><code>validUntil</code>定义了<code>scores</code>的有效时间。在此时间之后，分数被 Placement 视为无效，nil 代表永不过期。controller 需要在更新 score 时更新此字段，保证分数是最新状态。</li>
</ul>
<p>作为使用者，需要知道<code>AddOnPlacementScore</code>的资源名称<code>default</code>和<code>socre</code>名称<code>cpuAvailable</code> <code>memAvailable</code>。之后可在 Placement 中指定用此分数选择集群。</p>
<p>例如，下面的 Placement 想要选择具有最高<code>cpuAvailable</code>分数的前 3 个集群。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">apiVersion</span>: cluster.open-cluster-management.io/v1beta1
<span style="color:#66d9ef">kind</span>: Placement
<span style="color:#66d9ef">metadata</span>:
  <span style="color:#66d9ef">name</span>: placement
  <span style="color:#66d9ef">namespace</span>: ns1
<span style="color:#66d9ef">spec</span>:
  <span style="color:#66d9ef">numberOfClusters</span>: <span style="color:#ae81ff">3</span>
  <span style="color:#66d9ef">prioritizerPolicy</span>:
    <span style="color:#66d9ef">mode</span>: Exact
    <span style="color:#66d9ef">configurations</span>:
      - <span style="color:#66d9ef">scoreCoordinate</span>:
          <span style="color:#66d9ef">type</span>: AddOn
          <span style="color:#66d9ef">addOn</span>:
            <span style="color:#66d9ef">resourceName</span>: default
            <span style="color:#66d9ef">scoreName</span>: cpuAvailable
        <span style="color:#66d9ef">weight</span>: <span style="color:#ae81ff">1</span>
</code></pre></div><p><a href="https://github.com/open-cluster-management-io/enhancements/blob/main/enhancements/sig-architecture/32-extensiblescheduling/32-extensiblescheduling.md" title="32-extensiblescheduling">32-extensiblescheduling</a>包含了关于此设计的详细内容。</p>
<p>接下来，将用一个示例展示如何实现一个 controller 来更新<code>score</code>，并使用此<code>score</code>选择集群。</p>
<h2 id="示例">示例</h2>
<p>示例代码位于 GitHub 仓库<a href="https://github.com/open-cluster-management-io/addon-contrib/tree/main/resource-usage-collect-addon" title="resource-usage-collect-addon">resource-usage-collect-addon</a>。它提供的分数可实时反映集群的 CPU 和内存利用率。</p>
<p>示例使用 OCM <a href="https://github.com/open-cluster-management-io/addon-framework" title="addon-framework">addon-framework</a> 进行开发，它可以作为一个 addon 插件被安装到每个<code>ManagedCluster</code>上，并将集群的<code>score</code>更新到对应的<code>AddOnPlacementScore</code>中。（本文不涉及 addon 开发细节，详细内容可参考<a href="https://open-cluster-management.io/developer-guides/addon/" title="add-on开发指南">add-on 开发指南</a>。）</p>
<p>resource-usage-collect addon 遵循<code>hub-agent</code>的架构，如下所示。</p>
<p><img src="./assets/extend-multicluster-scheduling-capabilities.png" alt=""></p>
<p>resource-usage-collect addon 包括了一个 hub 上的 manager 和 managed cluster 上的 agent（绿色部分）。</p>
<p>工作流程为：</p>
<ul>
<li>hub 上运行 addon 的 manager，它负责在 hub 上为每个 agent 创建部署所需的<code>ManifestWork</code>。</li>
<li>在每个 managed cluster 上，work agent 负责监控 hub 上的<code>ManifestWork</code>并在 managed cluster 上安装 agent。</li>
<li>agent 是 addon 的核心部分，它负责为每个 managed cluster 创建<code>AddonPlacementScore</code>，并每 60 秒刷新一次<code>scores</code>和<code>validUntil</code>。</li>
<li>当<code>AddonPlacementScore</code>创建完成，用户便可以在<code>Placement</code>中指定<code>AddOnPlacementScore</code>的资源名称和<code>score</code>名称，根据分数来选择集群。</li>
<li>Placement controller 会在每个集群的命名空间中获取<code>AddOnPlacementScore</code>资源，在<code>scores</code>列表中读取分数，并使用该分数对集群进行打分排序。</li>
</ul>
<p>上述是<code>AddonPlacementScore</code>和 placement controller 的工作流程，非常容易理解。下面我们来试着运行样例代码。</p>
<p><strong>准备 OCM 环境（包含 2 个<code>ManagedCluster</code>）</strong></p>
<ol>
<li>运行<a href="https://github.com/open-cluster-management-io/OCM/tree/main/solutions/setup-dev-environment" title="setup dev environment by kind">setup dev environment by kind</a>准备环境。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -sSL https://raw.githubusercontent.com/open-cluster-management-io/OCM/main/solutions/setup-dev-environment/local-up.sh | bash
</code></pre></div><ol start="2">
<li>确认两个<code>ManagedCluster</code>和一个默认的<code>ManagedClusterSet</code>创建完成。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ clusteradm get clusters
NAME       ACCEPTED   AVAILABLE   CLUSTERSET   CPU   MEMORY       KUBERENETES VERSION
cluster1   true       True        default      <span style="color:#ae81ff">24</span>    49265496Ki   v1.23.4
cluster2   true       True        default      <span style="color:#ae81ff">24</span>    49265496Ki   v1.23.4

$ clusteradm get clustersets
NAME      BOUND NAMESPACES   STATUS
default                      <span style="color:#ae81ff">2</span> ManagedClusters selected
</code></pre></div><ol start="3">
<li>将默认<code>ManagedClusterSet</code>绑定到 default<code>Namespace</code>。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">clusteradm clusterset bind default --namespace default
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ clusteradm get clustersets
NAME      BOUND NAMESPACES   STATUS
default   default            <span style="color:#ae81ff">2</span> ManagedClusters selected
</code></pre></div><p><strong>安装 resource-usage-collect addon</strong></p>
<ol>
<li>下载源代码。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone git@github.com:open-cluster-management-io/addon-contrib.git
cd addon-contrib/resource-usage-collect-addon
</code></pre></div><ol start="2">
<li>编译容器镜像。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Set image name, this is an optional step.</span>
export IMAGE_NAME<span style="color:#f92672">=</span>quay.io/haoqing/resource-usage-collect-addon:latest
<span style="color:#75715e"># Build image</span>
make images
</code></pre></div><p>如果你使用了 kind，需要手工将镜像加载到 kind 环境中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kind load docker-image $IMAGE_NAME --name &lt;cluster_name&gt; <span style="color:#75715e"># kind load docker-image $IMAGE_NAME --name hub</span>
</code></pre></div><ol start="3">
<li>部署 resource-usage-collect addon。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">make deploy
</code></pre></div><ol start="4">
<li>验证安装成功。</li>
</ol>
<p>在 hub 集群上, 验证 resource-usage-collect-controller pod 运行成功。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get pods -n open-cluster-management | grep resource-usage-collect-controller
resource-usage-collect-controller-55c58bbc5-t45dh   1/1     Running   <span style="color:#ae81ff">0</span>          71s
</code></pre></div><p>在 hub 集群上, 验证每个 managed cluster 生成了对应的<code>AddonPlacementScore</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get addonplacementscore -A
NAMESPACE   NAME                   AGE
cluster1    resource-usage-score   3m23s
cluster2    resource-usage-score   3m24s
</code></pre></div><p><code>AddonPlacementScore</code>的 status 中应该包含了如下的分数。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get addonplacementscore -n cluster1 resource-usage-score -oyaml
apiVersion: cluster.open-cluster-management.io/v1alpha1
kind: AddOnPlacementScore
metadata:
  creationTimestamp: <span style="color:#e6db74">&#34;2022-08-08T06:46:04Z&#34;</span>
  generation: <span style="color:#ae81ff">1</span>
  name: resource-usage-score
  namespace: cluster1
  resourceVersion: <span style="color:#e6db74">&#34;3907&#34;</span>
  uid: 6c4280e4-38be-4d45-9c73-c18c84799781
status:
  scores:
  - name: cpuAvailable
    value: <span style="color:#ae81ff">12</span>
  - name: memAvailable
    value: <span style="color:#ae81ff">4</span>
</code></pre></div><p>如果<code>AddonPlacementScore</code>没有生成或者 status 中没有分数，可以登陆到 managed cluster 上，检查 resource-usage-collect-agent pod 是否正常运行。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get pods -n default | grep resource-usage-collect-agent
resource-usage-collect-agent-5b85cbf848-g5kqm   1/1     Running   <span style="color:#ae81ff">0</span>          2m
</code></pre></div><p><strong>通过自定义分数选择集群</strong></p>
<p>如果上述步骤运行正常，接下来我们可以试着创建一个<code>Placement</code>并通过自定义分数选择集群。</p>
<ol>
<li>创建一个<code>Placement</code>选择具有最高 cpuAvailable 分数的集群。</li>
</ol>
<p>当<code>scoreCoordinate</code>的类型<code>type</code>定义为<code>AddOn</code>时，placement controller 会在每个集群的命名空间中获取名称为<code>resource-usage-score</code>的<code>AddOnPlacementScore</code>资源，在<code>scores</code>列表中读取分数<code>cpuAvailable</code>，并使用该分数对集群进行打分排序。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#e6db74">&lt;&lt; EOF | kubectl apply -f -
</span><span style="color:#e6db74">apiVersion: cluster.open-cluster-management.io/v1beta1
</span><span style="color:#e6db74">kind: Placement
</span><span style="color:#e6db74">metadata:
</span><span style="color:#e6db74">  name: placement1
</span><span style="color:#e6db74">  namespace: default
</span><span style="color:#e6db74">spec:
</span><span style="color:#e6db74">  numberOfClusters: 1
</span><span style="color:#e6db74">  clusterSets:
</span><span style="color:#e6db74">    - default
</span><span style="color:#e6db74">  prioritizerPolicy:
</span><span style="color:#e6db74">    mode: Exact
</span><span style="color:#e6db74">    configurations:
</span><span style="color:#e6db74">      - scoreCoordinate:
</span><span style="color:#e6db74">          type: AddOn
</span><span style="color:#e6db74">          addOn:
</span><span style="color:#e6db74">            resourceName: resource-usage-score
</span><span style="color:#e6db74">            scoreName: cpuAvailable
</span><span style="color:#e6db74">        weight: 1
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><ol start="2">
<li>验证<code>PlacementDecision</code>。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl describe placementdecision -n default | grep Status -A <span style="color:#ae81ff">3</span>
Status:
  Decisions:
    Cluster Name:  cluster1
    Reason:
</code></pre></div><p>可以看到 Cluster1 被选中，出现在<code>PlacementDecision</code>的结果中。</p>
<p>运行如下命令获取<code>AddonPlacementScore</code>的自定义分数。可以看到&quot;cpuAvailable&quot;的分数是 12。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl get addonplacementscore -A -o<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{range .items[*]}{.metadata.namespace}{&#34;\t&#34;}{.status.scores}{&#34;\n&#34;}{end}&#39;</span>
cluster1        <span style="color:#f92672">[{</span><span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;cpuAvailable&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span>:12<span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;memAvailable&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span>:4<span style="color:#f92672">}]</span>
cluster2        <span style="color:#f92672">[{</span><span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;cpuAvailable&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span>:12<span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;memAvailable&#34;</span>,<span style="color:#e6db74">&#34;value&#34;</span>:4<span style="color:#f92672">}]</span>
</code></pre></div><p>在<code>Placement</code>的 events 也可以看到集群的分数是 12 分。这表明自定义分数被直接用于对集群进行打分和排序。由于上述 placement 中 numberOfClusters 定义为 1，最终只有 cluster1 被选中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ kubectl describe placement -n default placement1 | grep Events -A <span style="color:#ae81ff">10</span>
Events:
  Type    Reason          Age   From                 Message
  ----    ------          ----  ----                 -------
  Normal  DecisionCreate  50s   placementController  Decision placement1-decision-1 is created with placement placement1 in namespace default
  Normal  DecisionUpdate  50s   placementController  Decision placement1-decision-1 is updated with placement placement1 in namespace default
  Normal  ScoreUpdate     50s   placementController  cluster1:12 cluster2:12
</code></pre></div><h2 id="如何实现自定义分数控制器">如何实现自定义分数控制器</h2>
<p>现在你已经知道了如何安装 resource-usage-collect addon 并使用自定义分数来选择群集。接下来，让我们深入了解在实现自定义分数控制器<code>controller</code>时需要考虑的一些关键点。</p>
<h3 id="1-在哪里运行自定义分数控制器-controller">1. 在哪里运行自定义分数控制器 (controller)</h3>
<p>Controller 可以在 hub 集群或 managed cluster 上运行。可以结合具体的使用场景，选择将 controller 运行在何处。</p>
<p>比如，在我们的示例中，自定义分数控制器<code>controller</code>是使用 addon-famework 开发的，它遵循 hub-agent 架构。resource-usage-collect-agent 真正运行自定义分数程序，它安装在每个 managed cluster 上，获取 managed cluster 的可用 CPU 和内存，计算分数，并将其更新到<code>AddonPlacementScore</code>中。resource-usage-collect-controller 只负责安装代理 agent。</p>
<p>在其他情况下，例如，如果想使用 Thanos 中的指标为每个 managed cluster 计算得分，则自定义分数控制器<code>controller</code>需要放置在 hub 上，因为 Thanos 有从每个 managed cluster 收集的所有指标。</p>
<h3 id="2-如何维护addonplacementscore的生命周期">2. 如何维护<code>AddOnPlacementScore</code>的生命周期</h3>
<p>在我们的示例中，维护<code>AddonPlacementScore</code>的代码位于<a href="https://github.com/open-cluster-management-io/addon-contrib/blob/main/resource-usage-collect-addon/pkg/addon/agent/agent.go" title="pkg/addon/agent/agent.go">pkg/addon/agent/agent.go</a>中。</p>
<ul>
<li>
<p>何时创建<code>AddonPlacementScore</code>？</p>
<p><code>AddonPlacementScore</code>可以在 managed cluster 创建完成后创建，或者按需创建以减少 hub 上的 resource。</p>
<p>在上述示例中，addon 在 managed cluster 创建完成后，为每个 managed cluster 创建对应的<code>AddonPlacementScore</code>，并且生成初始分数。</p>
</li>
<li>
<p>何时更新<code>AddonPlacementScore</code>？</p>
<p>可以在监视数据发生变化时更新分数，或者至少在<code>ValidUntil</code>到期之前更新分数。
我们建议在更新分数时设置<code>ValidUntil</code>，以便 placement controller 可以知道分数是否仍然有效，防止分数长时间未能更新的情况。</p>
<p>在上述示例中，除了每 60 秒重新计算和更新分数外，当 managed cluster 中的节点或 Pod 资源发生更改时，也将触发更新。</p>
</li>
</ul>
<h3 id="3-如何计算分数">3. 如何计算分数</h3>
<p>计算分数的代码位于<a href="https://github.com/open-cluster-management-io/addon-contrib/blob/main/resource-usage-collect-addon/pkg/addon/agent/calculate.go" title="pkg/addon/agent/calculate.go">pkg/addon/agent/calculate.go</a>。有效的得分必须在-100 至 100 的范围内，你需要在将分数更新到<code>AddOnPlacementScore</code>之前将其归一化。在归一化分数时，可能会遇到以下情况。</p>
<ul>
<li>
<p>分数提供程序知道自定义分数的最大值和最小值。</p>
<p>在这种情况下，可以通过公式轻松实现平滑映射。假设实际值为 X，并且 X 在间隔[min，max]中，则得分=200 *（x-min）/（max-min）-100</p>
</li>
<li>
<p>分数提供程序不知道自定义分数的最大值和最小值。</p>
<p>在这种情况下，需要自己设置最大值和最小值，因为如果没有最大值和最小值，则无法将单个值 X 映射到范围[-100,100]。
然后，当 X 大于此最大值时，可以认为群集足够健康可以部署应用程序，可以将分数设置为 100。如果 X 小于最小值，则可以将分数设置为-100。</p>
<pre><code>if X &gt;= max
  score = 100
if X &lt;= min
  score = -100
</code></pre></li>
</ul>
<p>在我们的示例中，运行在每个托管群集上的 resource-usage-collect-agent 没有全局视角，无法知道所有群集的 CPU/内存使用率的最大值/最小值，因此我们在代码中手动将最大值设置为<code>MAXCPUCOUNT</code>和<code>MAXMEMCOUNT</code>，最小值设置为 0。分数计算公式可以简化为：<code>score = x / max * 100</code>。</p>
<h2 id="总结">总结</h2>
<p>在本文中，我们介绍了什么是OCM的可扩展调度，并使用示例展示了如何实现自定义分数控制器。此外，本文列出了开发者在实现第三方分数控制器时需要考虑的3个关键点。希望阅读本文后，您可以清楚地了解到如何使用OCM 来扩展多集群调度能力。</p>

</div>
<script type="text/javascript" src="/clipboard-copy.js"></script>
</div>
        </div>
        <div class="row"><nav class="ocm navbar navbar-expand-lg navbar-dark py-3">
  <div class="container-fluid flex-wrap flex-md-nowrap">
    <div class="text-light">&copy; 2023 Open Cluster Management Authors. The Linux Foundation® (TLF) has registered trademarks and uses trademarks. For a list of TLF trademarks, see <a href="https://www.linuxfoundation.org/trademark-usage/" target="_blank" style="color: #f8f9fa;">Trademark Usage</a></div>
  </div>
</nav>
<script type="text/javascript" src="/lang.js"></script>
</div>
    </div>
</body>
</html>
